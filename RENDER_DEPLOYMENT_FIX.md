# ğŸš€ Render FastAPI Deployment - Complete Fix

## âŒ The Problem
Render tried to use `gunicorn` (for Flask/Django) instead of `uvicorn` (for FastAPI).

## âœ… The Solution

### **Step 1: Update Render Settings**

Go to your Render dashboard and update these settings:

#### **Build & Deploy Settings:**
```
Environment: Python 3
Root Directory: backend
Build Command: pip install -r requirements.txt
Start Command: uvicorn app.main:app --host 0.0.0.0 --port $PORT --workers 1
```

âš ï¸ **IMPORTANT**: The start command MUST be exactly:
```bash
uvicorn app.main:app --host 0.0.0.0 --port $PORT --workers 1
```

**Why this works:**
- `app.main:app` â†’ Points to `backend/app/main.py` file and the `app` variable
- `--host 0.0.0.0` â†’ Allows external connections
- `--port $PORT` â†’ Uses Render's assigned port (usually 10000)
- `--workers 1` â†’ Single worker for free tier (saves memory)

---

### **Step 2: Verify requirements.txt**

Your `requirements.txt` already has the correct dependencies âœ…:
```
fastapi
uvicorn[standard]
```

The `[standard]` includes performance optimizations like:
- `uvloop` - Faster event loop
- `httptools` - Faster HTTP parsing
- `websockets` - WebSocket support

---

### **Step 3: Push Changes to GitHub**

```bash
git add .
git commit -m "Fix Render deployment with correct uvicorn command"
git push origin main
```

---

### **Step 4: Manual Redeploy on Render**

1. **Go to Render Dashboard**: https://dashboard.render.com
2. **Click on your service** (exoplanet-ai-backend)
3. **Click "Manual Deploy"** button (top right)
4. **Select "Deploy latest commit"**
5. **Wait 3-5 minutes** for deployment

---

## ğŸ“ Proper File Structure

Your current structure is correct:

```
nasa-2025-hackathon/
â”œâ”€â”€ backend/                    â† Root Directory in Render
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ main.py            â† FastAPI app here (app variable)
â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â””â”€â”€ services/
â”‚   â”œâ”€â”€ requirements.txt       â† Dependencies
â”‚   â”œâ”€â”€ Dockerfile             â† Optional (for Docker)
â”‚   â””â”€â”€ start.sh               â† Optional startup script
â”œâ”€â”€ render.yaml                â† Render config (in root)
â””â”€â”€ frontend files...
```

---

## ğŸ³ Optional: Production Dockerfile

If you want to use Docker instead (more control):

### **Update Dockerfile:**

```dockerfile
FROM python:3.11-slim

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements first (for caching)
COPY requirements.txt .

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY . .

# Expose port
EXPOSE 10000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "import requests; requests.get('http://localhost:10000/health')"

# Run uvicorn
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "10000", "--workers", "1"]
```

### **To use Docker on Render:**

1. **Settings** â†’ **Build & Deploy**
2. **Docker Command**: Leave empty (uses CMD from Dockerfile)
3. **Root Directory**: `backend`
4. Render will auto-detect Dockerfile

---

## ğŸ”§ Render Dashboard Configuration

### **Complete Settings Checklist:**

#### **General:**
- âœ… Name: `exoplanet-ai-backend`
- âœ… Region: Oregon (or closest to you)
- âœ… Branch: `main`
- âœ… Root Directory: `backend`

#### **Build & Deploy:**
- âœ… Environment: `Python 3`
- âœ… Build Command: `pip install -r requirements.txt`
- âœ… Start Command: `uvicorn app.main:app --host 0.0.0.0 --port $PORT --workers 1`

#### **Environment Variables:**
```
PYTHON_VERSION=3.11.0
ENVIRONMENT=production
DEBUG=false
SECRET_KEY=<auto-generated>
```

#### **Advanced:**
- âœ… Auto-Deploy: Yes (deploys on git push)
- âœ… Health Check Path: `/health`

---

## ğŸ¯ Quick Fix Commands

### **If you're in Render dashboard right now:**

1. **Go to Settings**
2. **Scroll to "Build & Deploy"**
3. **Update Start Command to:**
   ```
   uvicorn app.main:app --host 0.0.0.0 --port $PORT --workers 1
   ```
4. **Click "Save Changes"**
5. **Go back to main page**
6. **Click "Manual Deploy" â†’ "Deploy latest commit"**

---

## ğŸ§ª Test Your Deployment

Once deployed, test these endpoints:

### **1. Health Check:**
```bash
curl https://exoplanet-ai-backend.onrender.com/health
```

Expected response:
```json
{
  "success": true,
  "data": {
    "status": "healthy",
    "version": "1.0.0",
    "timestamp": 1234567890.123
  },
  "message": "ExoPlanet AI API is running"
}
```

### **2. API Docs:**
Visit: `https://exoplanet-ai-backend.onrender.com/docs`

### **3. Check Logs:**
In Render dashboard â†’ **Logs** tab

Look for:
```
INFO:     Started server process
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:10000
```

---

## ğŸ†˜ Troubleshooting

### **Error: "gunicorn: command not found"**
**Fix**: Update Start Command to use `uvicorn` (see Step 1)

### **Error: "ModuleNotFoundError: No module named 'app'"**
**Fix**: Make sure Root Directory is set to `backend`

### **Error: "Port already in use"**
**Fix**: Use `$PORT` variable (Render assigns this automatically)

### **Error: "Application startup failed"**
**Fix**: Check logs for missing dependencies or database connection issues

### **Slow Cold Starts (15+ seconds)**
**Normal**: Free tier sleeps after 15 min inactivity
**Solution**: 
- Upgrade to paid tier ($7/month)
- Or use a cron job to ping every 14 minutes

---

## ğŸ“Š Performance Tips

### **For Free Tier:**
```bash
# Use 1 worker (saves memory)
uvicorn app.main:app --host 0.0.0.0 --port $PORT --workers 1
```

### **For Paid Tier ($7/month):**
```bash
# Use multiple workers for better performance
uvicorn app.main:app --host 0.0.0.0 --port $PORT --workers 2
```

### **Production Optimizations:**
```bash
# Add these flags for production
uvicorn app.main:app \
  --host 0.0.0.0 \
  --port $PORT \
  --workers 2 \
  --loop uvloop \
  --http httptools \
  --log-level warning \
  --no-access-log
```

---

## âœ… Final Checklist

Before deploying, verify:

- [ ] `requirements.txt` has `fastapi` and `uvicorn[standard]`
- [ ] Root Directory set to `backend` in Render
- [ ] Start Command uses `uvicorn app.main:app`
- [ ] Port uses `$PORT` variable
- [ ] Environment variables are set
- [ ] Latest code pushed to GitHub
- [ ] Health check endpoint works locally

---

## ğŸ‰ Success!

Once deployed successfully, you'll see:

```
==> Build successful ğŸ‰
==> Deploying...
==> Starting service with 'uvicorn app.main:app --host 0.0.0.0 --port 10000'
INFO:     Started server process
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:10000
==> Your service is live at https://exoplanet-ai-backend.onrender.com
```

---

## ğŸ”— Update Frontend

After successful deployment, update your frontend config:

**File: `js/config.js`**
```javascript
const CONFIG = {
    API_BASE_URL: 'https://exoplanet-ai-backend.onrender.com',
    API_TIMEOUT: 30000
};
```

Then test the connection from your frontend!

---

## ğŸ“ Need More Help?

If you still have issues:
1. Check Render logs (Dashboard â†’ Logs)
2. Verify the exact error message
3. Make sure all files are committed and pushed
4. Try deleting and recreating the service

Your deployment should work now! ğŸš€
